
#include "trigonometry.h"

#include "common/types.h"
#include "common/debug/debug.h"

static IWRAM_DATA fixed16_t sine_lut[256] =
{
	0x00000000,
	0x00000648,
	0x00000C90,
	0x000012D5,
	0x00001918,
	0x00001F56,
	0x00002590,
	0x00002BC4,
	0x000031F1,
	0x00003817,
	0x00003E34,
	0x00004447,
	0x00004A50,
	0x0000504D,
	0x0000563E,
	0x00005C22,
	0x000061F8,
	0x000067BE,
	0x00006D74,
	0x0000731A,
	0x000078AD,
	0x00007E2F,
	0x0000839C,
	0x000088F6,
	0x00008E3A,
	0x00009368,
	0x00009880,
	0x00009D80,
	0x0000A268,
	0x0000A736,
	0x0000ABEB,
	0x0000B086,
	0x0000B505,
	0x0000B968,
	0x0000BDAF,
	0x0000C1D8,
	0x0000C5E4,
	0x0000C9D1,
	0x0000CD9F,
	0x0000D14D,
	0x0000D4DB,
	0x0000D848,
	0x0000DB94,
	0x0000DEBE,
	0x0000E1C6,
	0x0000E4AA,
	0x0000E76C,
	0x0000EA0A,
	0x0000EC83,
	0x0000EED9,
	0x0000F109,
	0x0000F314,
	0x0000F4FA,
	0x0000F6BA,
	0x0000F854,
	0x0000F9C8,
	0x0000FB15,
	0x0000FC3B,
	0x0000FD3B,
	0x0000FE13,
	0x0000FEC4,
	0x0000FF4E,
	0x0000FFB1,
	0x0000FFEC,
	0x00010000,
	0x0000FFEC,
	0x0000FFB1,
	0x0000FF4E,
	0x0000FEC4,
	0x0000FE13,
	0x0000FD3B,
	0x0000FC3B,
	0x0000FB15,
	0x0000F9C8,
	0x0000F854,
	0x0000F6BA,
	0x0000F4FA,
	0x0000F314,
	0x0000F109,
	0x0000EED9,
	0x0000EC83,
	0x0000EA0A,
	0x0000E76C,
	0x0000E4AA,
	0x0000E1C6,
	0x0000DEBE,
	0x0000DB94,
	0x0000D848,
	0x0000D4DB,
	0x0000D14D,
	0x0000CD9F,
	0x0000C9D1,
	0x0000C5E4,
	0x0000C1D8,
	0x0000BDAF,
	0x0000B968,
	0x0000B505,
	0x0000B086,
	0x0000ABEB,
	0x0000A736,
	0x0000A268,
	0x00009D80,
	0x00009880,
	0x00009368,
	0x00008E3A,
	0x000088F6,
	0x0000839C,
	0x00007E2F,
	0x000078AD,
	0x0000731A,
	0x00006D74,
	0x000067BE,
	0x000061F8,
	0x00005C22,
	0x0000563E,
	0x0000504D,
	0x00004A50,
	0x00004447,
	0x00003E34,
	0x00003817,
	0x000031F1,
	0x00002BC4,
	0x00002590,
	0x00001F56,
	0x00001918,
	0x000012D5,
	0x00000C90,
	0x00000648,
	0x00000000,
	0xFFFFF9B8,
	0xFFFFF370,
	0xFFFFED2B,
	0xFFFFE6E8,
	0xFFFFE0AA,
	0xFFFFDA70,
	0xFFFFD43C,
	0xFFFFCE0F,
	0xFFFFC7E9,
	0xFFFFC1CC,
	0xFFFFBBB9,
	0xFFFFB5B0,
	0xFFFFAFB3,
	0xFFFFA9C2,
	0xFFFFA3DE,
	0xFFFF9E08,
	0xFFFF9842,
	0xFFFF928C,
	0xFFFF8CE6,
	0xFFFF8753,
	0xFFFF81D1,
	0xFFFF7C64,
	0xFFFF770A,
	0xFFFF71C6,
	0xFFFF6C98,
	0xFFFF6780,
	0xFFFF6280,
	0xFFFF5D98,
	0xFFFF58CA,
	0xFFFF5415,
	0xFFFF4F7A,
	0xFFFF4AFB,
	0xFFFF4698,
	0xFFFF4251,
	0xFFFF3E28,
	0xFFFF3A1C,
	0xFFFF362F,
	0xFFFF3261,
	0xFFFF2EB3,
	0xFFFF2B25,
	0xFFFF27B8,
	0xFFFF246C,
	0xFFFF2142,
	0xFFFF1E3A,
	0xFFFF1B56,
	0xFFFF1894,
	0xFFFF15F6,
	0xFFFF137D,
	0xFFFF1127,
	0xFFFF0EF7,
	0xFFFF0CEC,
	0xFFFF0B06,
	0xFFFF0946,
	0xFFFF07AC,
	0xFFFF0638,
	0xFFFF04EB,
	0xFFFF03C5,
	0xFFFF02C5,
	0xFFFF01ED,
	0xFFFF013C,
	0xFFFF00B2,
	0xFFFF004F,
	0xFFFF0014,
	0xFFFF0000,
	0xFFFF0014,
	0xFFFF004F,
	0xFFFF00B2,
	0xFFFF013C,
	0xFFFF01ED,
	0xFFFF02C5,
	0xFFFF03C5,
	0xFFFF04EB,
	0xFFFF0638,
	0xFFFF07AC,
	0xFFFF0946,
	0xFFFF0B06,
	0xFFFF0CEC,
	0xFFFF0EF7,
	0xFFFF1127,
	0xFFFF137D,
	0xFFFF15F6,
	0xFFFF1894,
	0xFFFF1B56,
	0xFFFF1E3A,
	0xFFFF2142,
	0xFFFF246C,
	0xFFFF27B8,
	0xFFFF2B25,
	0xFFFF2EB3,
	0xFFFF3261,
	0xFFFF362F,
	0xFFFF3A1C,
	0xFFFF3E28,
	0xFFFF4251,
	0xFFFF4698,
	0xFFFF4AFB,
	0xFFFF4F7A,
	0xFFFF5415,
	0xFFFF58CA,
	0xFFFF5D98,
	0xFFFF6280,
	0xFFFF6780,
	0xFFFF6C98,
	0xFFFF71C6,
	0xFFFF770A,
	0xFFFF7C64,
	0xFFFF81D1,
	0xFFFF8753,
	0xFFFF8CE6,
	0xFFFF928C,
	0xFFFF9842,
	0xFFFF9E08,
	0xFFFFA3DE,
	0xFFFFA9C2,
	0xFFFFAFB3,
	0xFFFFB5B0,
	0xFFFFBBB9,
	0xFFFFC1CC,
	0xFFFFC7E9,
	0xFFFFCE0F,
	0xFFFFD43C,
	0xFFFFDA70,
	0xFFFFE0AA,
	0xFFFFE6E8,
	0xFFFFED2B,
	0xFFFFF370,
	0xFFFFF9B8
};

static IWRAM_DATA fixed16_t arc_sine_lut[256] = 
{ 
	0xFFFFFE6DE0,
	0xFFFFFE8DE6,
	0xFFFFFE9B31,
	0xFFFFFEA569,
	0xFFFFFEAE0B,
	0xFFFFFEB5AA,
	0xFFFFFEBC92,
	0xFFFFFEC2EE,
	0xFFFFFEC8DD,
	0xFFFFFECE73,
	0xFFFFFED3BD,
	0xFFFFFED8C9,
	0xFFFFFEDD9D,
	0xFFFFFEE241,
	0xFFFFFEE6BA,
	0xFFFFFEEB0E,
	0xFFFFFEEF40,
	0xFFFFFEF352,
	0xFFFFFEF749,
	0xFFFFFEFB26,
	0xFFFFFEFEEB,
	0xFFFFFF029A,
	0xFFFFFF0635,
	0xFFFFFF09BD,
	0xFFFFFF0D34,
	0xFFFFFF109A,
	0xFFFFFF13F1,
	0xFFFFFF1739,
	0xFFFFFF1A74,
	0xFFFFFF1DA2,
	0xFFFFFF20C4,
	0xFFFFFF23DA,
	0xFFFFFF26E5,
	0xFFFFFF29E6,
	0xFFFFFF2CDD,
	0xFFFFFF2FCB,
	0xFFFFFF32B0,
	0xFFFFFF358C,
	0xFFFFFF3860,
	0xFFFFFF3B2C,
	0xFFFFFF3DF1,
	0xFFFFFF40AF,
	0xFFFFFF4365,
	0xFFFFFF4615,
	0xFFFFFF48BF,
	0xFFFFFF4B62,
	0xFFFFFF4E00,
	0xFFFFFF5098,
	0xFFFFFF532B,
	0xFFFFFF55B8,
	0xFFFFFF5840,
	0xFFFFFF5AC3,
	0xFFFFFF5D42,
	0xFFFFFF5FBC,
	0xFFFFFF6232,
	0xFFFFFF64A3,
	0xFFFFFF6710,
	0xFFFFFF697A,
	0xFFFFFF6BDF,
	0xFFFFFF6E41,
	0xFFFFFF709F,
	0xFFFFFF72FA,
	0xFFFFFF7551,
	0xFFFFFF77A5,
	0xFFFFFF79F5,
	0xFFFFFF7C43,
	0xFFFFFF7E8E,
	0xFFFFFF80D6,
	0xFFFFFF831B,
	0xFFFFFF855D,
	0xFFFFFF879D,
	0xFFFFFF89DA,
	0xFFFFFF8C14,
	0xFFFFFF8E4C,
	0xFFFFFF9082,
	0xFFFFFF92B6,
	0xFFFFFF94E7,
	0xFFFFFF9717,
	0xFFFFFF9944,
	0xFFFFFF9B6F,
	0xFFFFFF9D98,
	0xFFFFFF9FC0,
	0xFFFFFFA1E5,
	0xFFFFFFA409,
	0xFFFFFFA62B,
	0xFFFFFFA84B,
	0xFFFFFFAA6A,
	0xFFFFFFAC87,
	0xFFFFFFAEA3,
	0xFFFFFFB0BD,
	0xFFFFFFB2D6,
	0xFFFFFFB4EE,
	0xFFFFFFB704,
	0xFFFFFFB919,
	0xFFFFFFBB2D,
	0xFFFFFFBD3F,
	0xFFFFFFBF50,
	0xFFFFFFC161,
	0xFFFFFFC370,
	0xFFFFFFC57E,
	0xFFFFFFC78B,
	0xFFFFFFC997,
	0xFFFFFFCBA3,
	0xFFFFFFCDAD,
	0xFFFFFFCFB7,
	0xFFFFFFD1C0,
	0xFFFFFFD3C8,
	0xFFFFFFD5CF,
	0xFFFFFFD7D6,
	0xFFFFFFD9DC,
	0xFFFFFFDBE1,
	0xFFFFFFDDE6,
	0xFFFFFFDFEB,
	0xFFFFFFE1EE,
	0xFFFFFFE3F2,
	0xFFFFFFE5F5,
	0xFFFFFFE7F7,
	0xFFFFFFE9F9,
	0xFFFFFFEBFB,
	0xFFFFFFEDFC,
	0xFFFFFFEFFD,
	0xFFFFFFF1FE,
	0xFFFFFFF3FF,
	0xFFFFFFF5FF,
	0xFFFFFFF800,
	0xFFFFFFFA00,
	0xFFFFFFFC00,
	0xFFFFFFFE00,
	0x00000000,
	0x00000200,
	0x00000400,
	0x00000600,
	0x00000800,
	0x00000A01,
	0x00000C01,
	0x00000E02,
	0x00001003,
	0x00001204,
	0x00001405,
	0x00001607,
	0x00001809,
	0x00001A0B,
	0x00001C0E,
	0x00001E12,
	0x00002015,
	0x0000221A,
	0x0000241F,
	0x00002624,
	0x0000282A,
	0x00002A31,
	0x00002C38,
	0x00002E40,
	0x00003049,
	0x00003253,
	0x0000345D,
	0x00003669,
	0x00003875,
	0x00003A82,
	0x00003C90,
	0x00003E9F,
	0x000040B0,
	0x000042C1,
	0x000044D3,
	0x000046E7,
	0x000048FC,
	0x00004B12,
	0x00004D2A,
	0x00004F43,
	0x0000515D,
	0x00005379,
	0x00005596,
	0x000057B5,
	0x000059D5,
	0x00005BF7,
	0x00005E1B,
	0x00006040,
	0x00006268,
	0x00006491,
	0x000066BC,
	0x000068E9,
	0x00006B19,
	0x00006D4A,
	0x00006F7E,
	0x000071B4,
	0x000073EC,
	0x00007626,
	0x00007863,
	0x00007AA3,
	0x00007CE5,
	0x00007F2A,
	0x00008172,
	0x000083BD,
	0x0000860B,
	0x0000885B,
	0x00008AAF,
	0x00008D06,
	0x00008F61,
	0x000091BF,
	0x00009421,
	0x00009686,
	0x000098F0,
	0x00009B5D,
	0x00009DCE,
	0x0000A044,
	0x0000A2BE,
	0x0000A53D,
	0x0000A7C0,
	0x0000AA48,
	0x0000ACD5,
	0x0000AF68,
	0x0000B200,
	0x0000B49E,
	0x0000B741,
	0x0000B9EB,
	0x0000BC9B,
	0x0000BF51,
	0x0000C20F,
	0x0000C4D4,
	0x0000C7A0,
	0x0000CA74,
	0x0000CD50,
	0x0000D035,
	0x0000D323,
	0x0000D61A,
	0x0000D91B,
	0x0000DC26,
	0x0000DF3C,
	0x0000E25E,
	0x0000E58C,
	0x0000E8C7,
	0x0000EC0F,
	0x0000EF66,
	0x0000F2CC,
	0x0000F643,
	0x0000F9CB,
	0x0000FD66,
	0x00010115,
	0x000104DA,
	0x000108B7,
	0x00010CAE,
	0x000110C0,
	0x000114F2,
	0x00011946,
	0x00011DBF,
	0x00012263,
	0x00012737,
	0x00012C43,
	0x0001318D,
	0x00013723,
	0x00013D12,
	0x0001436E,
	0x00014A56,
	0x000151F5,
	0x00015A97,
	0x000164CF,
	0x0001721A,
};
 
static IWRAM_DATA fixed16_t tangent_lut[256] =
{ 
	0x00000000,
	0x00000324,
	0x00000649,
	0x0000096E,
	0x00000C94,
	0x00000FBA,
	0x000012E2,
	0x0000160C,
	0x00001937,
	0x00001C64,
	0x00001F93,
	0x000022C5,
	0x000025F9,
	0x00002931,
	0x00002C6C,
	0x00002FAA,
	0x000032EC,
	0x00003632,
	0x0000397D,
	0x00003CCC,
	0x00004020,
	0x00004379,
	0x000046D8,
	0x00004A3D,
	0x00004DA8,
	0x0000511A,
	0x00005492,
	0x00005812,
	0x00005B99,
	0x00005F28,
	0x000062C0,
	0x00006660,
	0x00006A0A,
	0x00006DBD,
	0x0000717A,
	0x00007542,
	0x00007914,
	0x00007CF2,
	0x000080DC,
	0x000084D2,
	0x000088D6,
	0x00008CE7,
	0x00009106,
	0x00009534,
	0x00009971,
	0x00009DBE,
	0x0000A21C,
	0x0000A68C,
	0x0000AB0E,
	0x0000AFA3,
	0x0000B44C,
	0x0000B909,
	0x0000BDDD,
	0x0000C2C7,
	0x0000C7C9,
	0x0000CCE3,
	0x0000D218,
	0x0000D768,
	0x0000DCD4,
	0x0000E25E,
	0x0000E806,
	0x0000EDD0,
	0x0000F3BB,
	0x0000F9CB,
	0x00010000,
	0x0001065D,
	0x00010CE3,
	0x00011394,
	0x00011A74,
	0x00012184,
	0x000128C6,
	0x0001303F,
	0x000137F0,
	0x00013FDD,
	0x00014809,
	0x00015077,
	0x0001592D,
	0x0001622E,
	0x00016B7E,
	0x00017523,
	0x00017F22,
	0x00018980,
	0x00019445,
	0x00019F76,
	0x0001AB1C,
	0x0001B73F,
	0x0001C3E7,
	0x0001D11F,
	0x0001DEF1,
	0x0001ED6A,
	0x0001FC96,
	0x00020C84,
	0x00021D44,
	0x00022EE9,
	0x00024187,
	0x00025534,
	0x00026A0A,
	0x00028026,
	0x000297A8,
	0x0002B0B5,
	0x0002CB79,
	0x0002E823,
	0x000306EC,
	0x00032816,
	0x00034BEB,
	0x000372C6,
	0x00039D11,
	0x0003CB48,
	0x0003FE02,
	0x000435F7,
	0x00047405,
	0x0004B940,
	0x00050700,
	0x00055EF9,
	0x0005C35D,
	0x00063709,
	0x0006BDD0,
	0x00075CE6,
	0x00081B98,
	0x0009046E,
	0x000A2736,
	0x000B9CC6,
	0x000D8E82,
	0x001046EA,
	0x00145B00,
	0x001B2672,
	0x0028BC49,
	0x00517BB6,
	0x00000000,
	0xFFAE844A,
	0xFFD743B7,
	0xFFE4D98E,
	0xFFEBA500,
	0xFFEFB916,
	0xFFF2717E,
	0xFFF4633A,
	0xFFF5D8CA,
	0xFFF6FB92,
	0xFFF7E468,
	0xFFF8A31A,
	0xFFF94230,
	0xFFF9C8F7,
	0xFFFA3CA3,
	0xFFFAA107,
	0xFFFAF900,
	0xFFFB46C0,
	0xFFFB8BFB,
	0xFFFBCA09,
	0xFFFC01FE,
	0xFFFC34B8,
	0xFFFC62EF,
	0xFFFC8D3A,
	0xFFFCB415,
	0xFFFCD7EA,
	0xFFFCF914,
	0xFFFD17DD,
	0xFFFD3487,
	0xFFFD4F4B,
	0xFFFD6858,
	0xFFFD7FDA,
	0xFFFD95F6,
	0xFFFDAACC,
	0xFFFDBE79,
	0xFFFDD117,
	0xFFFDE2BC,
	0xFFFDF37C,
	0xFFFE036A,
	0xFFFE1296,
	0xFFFE210F,
	0xFFFE2EE1,
	0xFFFE3C19,
	0xFFFE48C1,
	0xFFFE54E4,
	0xFFFE608A,
	0xFFFE6BBB,
	0xFFFE7680,
	0xFFFE80DE,
	0xFFFE8ADD,
	0xFFFE9482,
	0xFFFE9DD2,
	0xFFFEA6D3,
	0xFFFEAF89,
	0xFFFEB7F7,
	0xFFFEC023,
	0xFFFEC810,
	0xFFFECFC1,
	0xFFFED73A,
	0xFFFEDE7C,
	0xFFFEE58C,
	0xFFFEEC6C,
	0xFFFEF31D,
	0xFFFEF9A3,
	0xFFFF0000,
	0xFFFF0635,
	0xFFFF0C45,
	0xFFFF1230,
	0xFFFF17FA,
	0xFFFF1DA2,
	0xFFFF232C,
	0xFFFF2898,
	0xFFFF2DE8,
	0xFFFF331D,
	0xFFFF3837,
	0xFFFF3D39,
	0xFFFF4223,
	0xFFFF46F7,
	0xFFFF4BB4,
	0xFFFF505D,
	0xFFFF54F2,
	0xFFFF5974,
	0xFFFF5DE4,
	0xFFFF6242,
	0xFFFF668F,
	0xFFFF6ACC,
	0xFFFF6EFA,
	0xFFFF7319,
	0xFFFF772A,
	0xFFFF7B2E,
	0xFFFF7F24,
	0xFFFF830E,
	0xFFFF86EC,
	0xFFFF8ABE,
	0xFFFF8E86,
	0xFFFF9243,
	0xFFFF95F6,
	0xFFFF99A0,
	0xFFFF9D40,
	0xFFFFA0D8,
	0xFFFFA467,
	0xFFFFA7EE,
	0xFFFFAB6E,
	0xFFFFAEE6,
	0xFFFFB258,
	0xFFFFB5C3,
	0xFFFFB928,
	0xFFFFBC87,
	0xFFFFBFE0,
	0xFFFFC334,
	0xFFFFC683,
	0xFFFFC9CE,
	0xFFFFCD14,
	0xFFFFD056,
	0xFFFFD394,
	0xFFFFD6CF,
	0xFFFFDA07,
	0xFFFFDD3B,
	0xFFFFE06D,
	0xFFFFE39C,
	0xFFFFE6C9,
	0xFFFFE9F4,
	0xFFFFED1E,
	0xFFFFF046,
	0xFFFFF36C,
	0xFFFFF692,
	0xFFFFF9B7,
	0xFFFFFCDC
};

//-----------------------------------------------------------------------------
fixed16_t fixed16_sine(fixed16_t x)		//	make this faster to sample
{
	x = fixed16_mod(x, fixed16_2pi);	//	rather than mod, bitmask
	if (x < 0)
		x += fixed16_2pi;
	x = fixed16_div(x, fixed16_2pi);	//	embed all these calculations into the lut		//	crazy hidden cost here
	x <<= 8;

	int idx = fixed16_to_int(x);
	return sine_lut[idx];		
	//	if we need more precision linear interpolation between previous and next would massively help

	//	input X (wrap on 2pi)

	//	output -1 => 1
}

//-----------------------------------------------------------------------------
fixed16_t fixed16_cosine(fixed16_t x)
{
	x += fixed16_pi >> 1; 
	return fixed16_sine(x);
} 

//-----------------------------------------------------------------------------
fixed16_t fixed16_tangent(fixed16_t x)
{
	x = fixed16_mod(x, fixed16_pi);
	if (x < 0)
		x += fixed16_pi;
	x = fixed16_div(x, fixed16_pi);
	x <<= 8;

	int32_t idx = fixed16_to_int(x);
	return tangent_lut[idx];
}

//-----------------------------------------------------------------------------
fixed16_t fixed16_arcsine(fixed16_t x)
{
	debug_assert(x >= -fixed16_one && x <= fixed16_one, "");

	//	input -1 => 1 
	//		convert to 0 => 2
	x += fixed16_one;

	//	256 sample => 8 bits accurate => 1.7 fixed point 
	int32_t idx = (x >> 9) & 0xFF;
	return arc_sine_lut[idx];
}

//-----------------------------------------------------------------------------
fixed16_t fixed16_arccosine(fixed16_t x)
{
	return (fixed16_pi >> 1) - fixed16_arcsine(x);	
}

//-----------------------------------------------------------------------------
fixed16_t fixed16_arctangent2(fixed16_t y, fixed16_t x)
{
	fixed16_t ONEQTR_PI = fixed16_pi >> 2;
	fixed16_t THRQTR_PI = ONEQTR_PI + ONEQTR_PI + ONEQTR_PI;

	fixed16_t r, angle;
	fixed16_t abs_y = fixed16_abs(y) + 1;      // kludge to prevent 0/0 condition
	if (x < fixed16_zero)
	{
		r = fixed16_div((x + abs_y), (abs_y - x));
		angle = THRQTR_PI;
	}
	else
	{
		r = fixed16_div((x - abs_y), (x + abs_y));
		angle = ONEQTR_PI;
	}
	angle += fixed16_mul((fixed16_mul(fixed16_mul(F16(0.1963f), r), r) - F16(0.9817f)), r);

	if (y < fixed16_zero)
		return (-angle);     // negate if in quad III or IV
	else
		return (angle);
}
